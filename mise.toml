[tasks.ios-snapshots]
description = "Run all iOS snapshot tests on the booted simulator (no clones)"
run = [
  "set -euo pipefail; sim_udid=${SIM_ID:-$(python3 - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\"xcrun\", \"simctl\", \"list\", \"devices\", \"booted\", \"-j\"], text=True)\ndata = json.loads(raw)\nfor devices in data.get(\"devices\", {}).values():\n    for device in devices:\n        if device.get(\"state\") == \"Booted\" and device.get(\"isAvailable\", True):\n            print(device.get(\"udid\"))\n            raise SystemExit(0)\nraise SystemExit(1)\nPY\n)}; if [ -z \"$sim_udid\" ]; then echo \"No booted simulator found. Set SIM_ID or boot one.\"; exit 1; fi; set -o pipefail; xcodebuild test -project \"SwiftUIHTMLExample.xcodeproj\" -scheme \"SwiftUIHTMLExample\" -testPlan \"SwiftUIHTMLExample\" -destination \"platform=iOS Simulator,id=$sim_udid\" -configuration Debug -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -maximum-parallel-testing-workers 1 -resultBundlePath /tmp/swiftuihtml-ios-latest.xcresult | xcbeautify --renderer terminal"
]

[tasks.ios-snapshots-htmlbasic]
description = "Run only HTMLBasicTests snapshots on the booted simulator (no clones)"
run = [
  "set -euo pipefail; sim_udid=${SIM_ID:-$(python3 - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\"xcrun\", \"simctl\", \"list\", \"devices\", \"booted\", \"-j\"], text=True)\ndata = json.loads(raw)\nfor devices in data.get(\"devices\", {}).values():\n    for device in devices:\n        if device.get(\"state\") == \"Booted\" and device.get(\"isAvailable\", True):\n            print(device.get(\"udid\"))\n            raise SystemExit(0)\nraise SystemExit(1)\nPY\n)}; if [ -z \"$sim_udid\" ]; then echo \"No booted simulator found. Set SIM_ID or boot one.\"; exit 1; fi; set -o pipefail; xcodebuild test -project \"SwiftUIHTMLExample.xcodeproj\" -scheme \"SwiftUIHTMLExample\" -testPlan \"SwiftUIHTMLExample\" -destination \"platform=iOS Simulator,id=$sim_udid\" -configuration Debug -only-testing:SwiftUIHTMLExampleTests/HTMLBasicTests -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -maximum-parallel-testing-workers 1 -resultBundlePath /tmp/swiftuihtml-ios-latest.xcresult | xcbeautify --renderer terminal"
]

[tasks.ios-snapshot-single]
description = "Run a single snapshot test (set TEST_ONLY to e.g. SwiftUIHTMLExampleTests/HTMLBasicTests/testHTMLImageWithLineHeight)"
run = [
  "set -euo pipefail; if [ -z \"${TEST_ONLY:-}\" ]; then echo \"Set TEST_ONLY to a test identifier\"; exit 1; fi; sim_udid=${SIM_ID:-$(python3 - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\"xcrun\", \"simctl\", \"list\", \"devices\", \"booted\", \"-j\"], text=True)\ndata = json.loads(raw)\nfor devices in data.get(\"devices\", {}).values():\n    for device in devices:\n        if device.get(\"state\") == \"Booted\" and device.get(\"isAvailable\", True):\n            print(device.get(\"udid\"))\n            raise SystemExit(0)\nraise SystemExit(1)\nPY\n)}; if [ -z \"$sim_udid\" ]; then echo \"No booted simulator found. Set SIM_ID or boot one.\"; exit 1; fi; set -o pipefail; xcodebuild test -project \"SwiftUIHTMLExample.xcodeproj\" -scheme \"SwiftUIHTMLExample\" -testPlan \"SwiftUIHTMLExample\" -destination \"platform=iOS Simulator,id=$sim_udid\" -configuration Debug -only-testing:${TEST_ONLY} -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -maximum-parallel-testing-workers 1 -resultBundlePath /tmp/swiftuihtml-ios-latest.xcresult | xcbeautify --renderer terminal"
]

[tasks.ios-snapshots-report]
description = "Generate HTML snapshot report from /tmp/swiftuihtml-ios-artifacts"
run = [
  "set -euo pipefail; python3 - <<'PY'\nimport os, time, html\nfrom pathlib import Path\n\nartifacts_dir = Path('/tmp/swiftuihtml-ios-artifacts/HTMLBasicTests')\nbaseline_dir = Path('SwiftUIHTMLExampleTests/__Snapshots__/HTMLBasicTests').resolve()\n\nif not artifacts_dir.exists():\n    raise SystemExit('No artifacts found at ' + str(artifacts_dir))\n\nstamp = time.strftime('%Y%m%d-%H%M%S')\nreport_dir = Path(f'/tmp/swiftuihtml-ios-snapshot-report-{stamp}')\nreport_dir.mkdir(parents=True, exist_ok=True)\n\nrows = []\nfor artifact in sorted(artifacts_dir.glob('*.png')):\n    name = artifact.name\n    baseline = baseline_dir / name\n    rows.append((name, baseline, artifact))\n\ncss = \"\"\"\nbody { font-family: -apple-system, Helvetica, Arial, sans-serif; margin: 24px; background: #f7f7f7; }\n.header { margin-bottom: 16px; }\n.card { background: #fff; border-radius: 12px; padding: 16px; margin: 16px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }\n.title { font-weight: 600; margin-bottom: 12px; }\n.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }\n.label { font-size: 12px; color: #666; margin-bottom: 6px; }\nimg { width: 100%; height: auto; border: 1px solid #eee; background: #fff; }\n.path { font-size: 11px; color: #999; word-break: break-all; }\n.missing { color: #b00020; font-size: 12px; }\n\"\"\"\n\nparts = [\"<!doctype html>\", \"<html><head><meta charset='utf-8'>\", f\"<style>{css}</style>\", \"</head><body>\"]\nparts.append(f\"<div class='header'><h2>SwiftUIHTML iOS Snapshot Report</h2><div>Artifacts: {html.escape(str(artifacts_dir))}</div></div>\")\n\nfor name, baseline, artifact in rows:\n    parts.append(\"<div class='card'>\")\n    parts.append(f\"<div class='title'>{html.escape(name)}</div>\")\n    parts.append(\"<div class='grid'>\")\n    parts.append(\"<div>\")\n    parts.append(\"<div class='label'>Baseline</div>\")\n    if baseline.exists():\n        parts.append(f\"<img src='file://{baseline}' />\")\n        parts.append(f\"<div class='path'>{html.escape(str(baseline))}</div>\")\n    else:\n        parts.append(\"<div class='missing'>Missing baseline</div>\")\n        parts.append(f\"<div class='path'>{html.escape(str(baseline))}</div>\")\n    parts.append(\"</div>\")\n    parts.append(\"<div>\")\n    parts.append(\"<div class='label'>New</div>\")\n    parts.append(f\"<img src='file://{artifact}' />\")\n    parts.append(f\"<div class='path'>{html.escape(str(artifact))}</div>\")\n    parts.append(\"</div>\")\n    parts.append(\"</div>\")\n    parts.append(\"</div>\")\n\nparts.append(\"</body></html>\")\n\nreport_path = report_dir / 'index.html'\nreport_path.write_text('\\n'.join(parts), encoding='utf-8')\nprint(report_path)\nPY"
]
