[tasks.ios-snapshots]
description = "Run all iOS snapshot tests on the booted simulator (no clones)"
run = [
  "set -euo pipefail; sim_udid=${SIM_ID:-$(python3 - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\"xcrun\", \"simctl\", \"list\", \"devices\", \"booted\", \"-j\"], text=True)\ndata = json.loads(raw)\nfor devices in data.get(\"devices\", {}).values():\n    for device in devices:\n        if device.get(\"state\") == \"Booted\" and device.get(\"isAvailable\", True):\n            print(device.get(\"udid\"))\n            raise SystemExit(0)\nraise SystemExit(1)\nPY\n)}; if [ -z \"$sim_udid\" ]; then echo \"No booted simulator found. Set SIM_ID or boot one.\"; exit 1; fi; set -o pipefail; xcodebuild test -project \"SwiftUIHTMLExample.xcodeproj\" -scheme \"SwiftUIHTMLExample\" -testPlan \"SwiftUIHTMLExample\" -destination \"platform=iOS Simulator,id=$sim_udid\" -configuration Debug -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -maximum-parallel-testing-workers 1 -resultBundlePath /tmp/swiftuihtml-ios-latest.xcresult | xcbeautify --renderer terminal"
]

[tasks.ios-snapshots-htmlbasic]
description = "Run only HTMLBasicTests snapshots on the booted simulator (no clones)"
run = [
  "set -euo pipefail; sim_udid=${SIM_ID:-$(python3 - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\"xcrun\", \"simctl\", \"list\", \"devices\", \"booted\", \"-j\"], text=True)\ndata = json.loads(raw)\nfor devices in data.get(\"devices\", {}).values():\n    for device in devices:\n        if device.get(\"state\") == \"Booted\" and device.get(\"isAvailable\", True):\n            print(device.get(\"udid\"))\n            raise SystemExit(0)\nraise SystemExit(1)\nPY\n)}; if [ -z \"$sim_udid\" ]; then echo \"No booted simulator found. Set SIM_ID or boot one.\"; exit 1; fi; set -o pipefail; xcodebuild test -project \"SwiftUIHTMLExample.xcodeproj\" -scheme \"SwiftUIHTMLExample\" -testPlan \"SwiftUIHTMLExample\" -destination \"platform=iOS Simulator,id=$sim_udid\" -configuration Debug -only-testing:SwiftUIHTMLExampleTests/HTMLBasicTests -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -maximum-parallel-testing-workers 1 -resultBundlePath /tmp/swiftuihtml-ios-latest.xcresult | xcbeautify --renderer terminal"
]

[tasks.ios-snapshot-single]
description = "Run a single snapshot test (set TEST_ONLY to e.g. SwiftUIHTMLExampleTests/HTMLBasicTests/testHTMLImageWithLineHeight)"
run = [
  "set -euo pipefail; if [ -z \"${TEST_ONLY:-}\" ]; then echo \"Set TEST_ONLY to a test identifier\"; exit 1; fi; sim_udid=${SIM_ID:-$(python3 - <<'PY'\nimport json, subprocess\nraw = subprocess.check_output([\"xcrun\", \"simctl\", \"list\", \"devices\", \"booted\", \"-j\"], text=True)\ndata = json.loads(raw)\nfor devices in data.get(\"devices\", {}).values():\n    for device in devices:\n        if device.get(\"state\") == \"Booted\" and device.get(\"isAvailable\", True):\n            print(device.get(\"udid\"))\n            raise SystemExit(0)\nraise SystemExit(1)\nPY\n)}; if [ -z \"$sim_udid\" ]; then echo \"No booted simulator found. Set SIM_ID or boot one.\"; exit 1; fi; set -o pipefail; xcodebuild test -project \"SwiftUIHTMLExample.xcodeproj\" -scheme \"SwiftUIHTMLExample\" -testPlan \"SwiftUIHTMLExample\" -destination \"platform=iOS Simulator,id=$sim_udid\" -configuration Debug -only-testing:${TEST_ONLY} -parallel-testing-enabled NO -maximum-concurrent-test-simulator-destinations 1 -maximum-parallel-testing-workers 1 -resultBundlePath /tmp/swiftuihtml-ios-latest.xcresult | xcbeautify --renderer terminal"
]

[tasks.ios-snapshots-report]
description = "Generate HTML snapshot report from /tmp/swiftuihtml-ios-artifacts"
run = [
  "set -euo pipefail; python3 \"scripts/snapshot_report.py\" --artifacts \"/tmp/swiftuihtml-ios-artifacts/HTMLBasicTests\" --baseline \"SwiftUIHTMLExampleTests/__Snapshots__/HTMLBasicTests\" --title \"SwiftUIHTML iOS Snapshot Report\" --out-prefix \"/tmp/swiftuihtml-ios-snapshot-report\""
]

[tasks.macos-snapshots-report]
description = "Generate HTML snapshot report from the latest /tmp/swiftuihtml-macos-artifacts*"
run = [
  "set -euo pipefail; artifacts_root=$(ls -1dt /tmp/swiftuihtml-macos-artifacts-* /tmp/swiftuihtml-macos-artifacts 2>/dev/null | head -n 1 || true); if [ -z \"$artifacts_root\" ]; then echo \"No macOS snapshot artifacts found\"; exit 1; fi; python3 \"scripts/snapshot_report.py\" --artifacts \"$artifacts_root\" --baseline \"SwiftUIHTMLExampleTests/__Snapshots__/HTMLBasicTests\" --title \"SwiftUIHTML macOS Snapshot Report\" --out-prefix \"/tmp/swiftuihtml-macos-snapshot-report\""
]
